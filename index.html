<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="subject" content="Simple blog">
    <meta name="description" content="Simple blog">
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="google" content="nositelinkssearchbox">
    <meta name="google" content="notranslate">
    <link rel="me" href="https://www.facebook.com/gennadii.genin" type="text/html">
    <link rel="me" href="mailto:genin.gennadiigendos2010@yandex.ru">
    <link rel="me" href="sms:+48792371282">
    <title>Blog</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="./dist/styles.css">
    <!--page icon-->
    <!--<link rel="icon" type="image/png" href=""/>-->
    <!--<meta http-equiv="refresh" content="1">-->
</head>
<body>
<div id="app">
    <div id="control">
        <button onclick="hideCards()">Hide</button>
        <div id="sort-by-date">
            <button onclick="sortByDateUp()">Up</button>
            <button onclick="sortByDateDown()">Down</button>
        </div>
        <div id="sorting-tags"></div>
    </div>
    <div id="cards"></div>
</div>
<!--<script src="src/index.js"></script>-->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
<script src="./dist/bundle.js"></script>
<script>
    window.onload = () => {
        fetch('https://api.myjson.com/bins/152f9j')
            .then(response => {
                response.json().then(json_data => {
                    createApp(json_data.data);
                    return window.parent.json_data = json_data;
                })
            })
            .catch(err => {
                console.log('Woooops, shit happens');
                console.log(err);
            })
    };

    // json structure
    /*{
        "title":"Quo repudiandae qui sit.",
        "description":"Some text",
        "image":"http://via.placeholder.com/150x150",
        "createdAt":"0290-01-20T18:19:35.727Z",
        "tags":[
        "Business",
        "Politics",
        "Sport"]
    }*/

    let app = document.getElementById('app');
    let control = document.getElementById('control');
    let tags = document.getElementById('sorting-tags');
    tags.addEventListener('click', (e) => {
        e.stopPropagation();
    });

    function createApp(j_data) {
        let cards = document.getElementById('cards');
        let tags_arr = getUniqueTags(j_data);
        createTags(tags_arr);
        for (let i = 0; i < j_data.length; i++) {
            createCard(j_data[i]);
        }
        control.appendChild(tags);
        app.appendChild(control);
        app.appendChild(cards);

        setDateIndexes();
        hideCards();
        // sortByDateUp();
        let retrievedObject = localStorage.getItem('lastAction');
        console.log(JSON.parse(retrievedObject));
        let parsedLocal = JSON.parse(retrievedObject);
        if (parsedLocal !== null) {
            console.log('retrievedObject !== null');
            if (parsedLocal.dateUp === true) {
                console.log('up');
                sortByDateUp();
            }
            if (parsedLocal.dateDown === true) {
                console.log('down');
                sortByDateDown();
            }
            if (parsedLocal.tags === true) {
                console.log('tags');
                sortElements(parsedLocal.selected_tags);
                let tags = document.getElementsByClassName('tag');
                for (let i = 0; i < tags.length; i++) {
                    for (let c = 0; c < parsedLocal.selected_tags.length; c++) {
                        if (tags[i].innerText === parsedLocal.selected_tags[c]) {
                            tags[i].setAttribute('class', 'tag selected-tag');
                        }
                    }
                }
            }
        } else sortByDateUp();
    }

    function getUniqueTags(j_data) {
        let allTags = [];
        for (let i = 0; i < j_data.length; i++) {
            for (let c = 0; c < j_data[i].tags.length; c++) {
                allTags.push(j_data[i].tags[c]);
            }
        }
        return allTags.filter(onlyUnique);
    }

    function createTags(tags_arr) {
        for (let i = 0; i < tags_arr.length; i++) {
            let tag = document.createElement('span');
            tag.setAttribute('class', 'tag');
            tag.setAttribute('onclick', 'toggleTag(event)');
            let tagText = document.createTextNode(tags_arr[i]);
            tag.appendChild(tagText);
            tags.appendChild(tag);
        }
    }

    function createCard(j_data) {
        let cards = document.getElementById('cards');
        let card = document.createElement('div');
        card.setAttribute('class', 'card-box');

        let deleteButton = document.createElement('button');
        deleteButton.setAttribute('onclick', 'deleteElement(event)');
        let deleteButtonText = document.createTextNode('delete');
        deleteButton.appendChild(deleteButtonText);

        let title = document.createElement('h3');
        let titleText = document.createTextNode(j_data.title);
        title.appendChild(titleText);

        let description = document.createElement('span');
        description.setAttribute('class', 'description');
        let descriptionText = document.createTextNode(j_data.description);
        description.appendChild(descriptionText);

        let photo = document.createElement('img');
        photo.setAttribute('src', j_data.image);

        let date = document.createElement('span');
        date.setAttribute('class', 'date');
        let dateText = document.createTextNode(j_data.createdAt);
        date.appendChild(dateText);

        let tags = document.createElement('ul');
        for (let i = 0; i < j_data.tags.length; i++) {
            let tag = document.createElement('li');
            let tagText = document.createTextNode(j_data.tags[i]);
            tag.appendChild(tagText);
            tags.appendChild(tag);
        }

        card.appendChild(deleteButton);
        card.appendChild(title);
        card.appendChild(description);
        card.appendChild(photo);
        card.appendChild(date);
        card.appendChild(tags);
        cards.appendChild(card);
    }

    function deleteElement(e) {
        let cards = document.getElementById('cards');
        console.log(e);
        e.stopPropagation();
        cards.removeChild(e.path[1]);
        setDateIndexes();
    }

    let selected_tags_arr = [];

    function toggleTag(e) {
        // console.log('in toggle');
        e.stopPropagation();
        let tag = e.target;
        // can't select more than 3 tags | I wrote it, because there r can be only max of 3 tags
        if (selected_tags_arr.length === 3 && !tag.classList.contains('selected-tag')) {
            alert('Remove one tag');
            return;
        }
        toggleButton();
        tag.classList.toggle('selected-tag');
        if (tag.classList.contains('selected-tag')) {
            selected_tags_arr.push(tag.innerHTML);
        } else {
            for (let i = 0; i < selected_tags_arr.length; i++) {
                if (tag.innerHTML === selected_tags_arr[i]) {
                    selected_tags_arr.splice(i, 1);
                }
            }
        }
        localStorage.setItem('lastAction', JSON.stringify({
            'dateUp': false,
            'dateDown': false,
            'tags': true,
            'selected_tags': selected_tags_arr
        }));
        sortElements(selected_tags_arr);
    }

    function toggleDefaultTags() {
        let tags = document.getElementsByClassName('tag');
        for (let i = 0; i < tags.length; i++) {
            if (tags[i].classList.contains('selected-tag')) {
                tags[i].setAttribute('class', 'tag');
            }
        }
    }

    function toggleButton(element) {
        let buttons_div = document.getElementById('sort-by-date');
        for (let i = 0; i < buttons_div.children.length; i++) {
            buttons_div.children[i].setAttribute('class', null);
        }
        if (element) {
            element.setAttribute('class', 'selected-button');
        }
    }

    // sorting functions

    function sortElements(selected) {
        // console.log('in sort');
        let el_to_sort = document.getElementsByClassName('card-box');
        for (let i = 0; i < el_to_sort.length; i++) {

        }
        if (selected && selected.length >= 1) {
            console.log(selected);
            for (let i = 0; i < el_to_sort.length; i++) {
                setIndexesByTags(el_to_sort[i], selected);
            }
            swapByTagsAndTime();
        } else {
            // console.log(selected);
            sortByDateUp();
        }
    }

    function swapByTagsAndTime() {
        // console.log('in swapByTagsAndTime');
        let cards = document.getElementsByClassName('card-box');
        // get all unique indexes
        let allTagIndexes = [];
        let uniqueTagsIndexes;
        for (let i = 0; i < cards.length; i++) {
            allTagIndexes.push(cards[i].tagIndex);
        }
        uniqueTagsIndexes = allTagIndexes.filter(onlyUnique);
        let sortedByTagsArr = [];
        for (let c = 0; c < uniqueTagsIndexes.length; c++) {
            sortedByTagsArr[c] = [];
        }
        for (let i = 0; i < cards.length; i++) {
            for (let c = 0; c < uniqueTagsIndexes.length; c++) {
                if (cards[i].tagIndex === c) {
                    sortedByTagsArr[c].push(cards[i]);
                }
            }
        }
        // console.log(sortedByTagsArr);
        let clone_nodes_arr = [];
        for (let i = 0; i < sortedByTagsArr.length; i++) {
            let arr = [];
            for (let c = 0; c < sortedByTagsArr[i].length; c++) {
                arr.push(sortedByTagsArr[i][c].dateIndex);
                // console.log(sortedByTagsArr[i][c].dateIndex);
            }
            arr = arr.sort(sortNumber);
            // console.log(arr);
            for (let c = 0; c < arr.length; c++) {
                // console.log(arr[c]);
                for (let j = 0; j < sortedByTagsArr[i].length; j++) {
                    if (arr[c] === sortedByTagsArr[i][j].dateIndex) {
                        arr[c] = sortedByTagsArr[i][j];
                    }
                }
            }
            //this is ordered by tags and than by date arr
            clone_nodes_arr.push(arr);
        }
        // clone_nodes = clone_nodes.reverse();
        let clone_reverse = [];
        for (let i = clone_nodes_arr.length - 1; i >= 0; i--) {
            for (let c = 0; c < clone_nodes_arr[i].length; c++) {
                clone_reverse.push(clone_nodes_arr[i][c]);
            }
        }
        for (let i = 0; i < cards.length; i++) {
            swapNodes(cards[i], clone_reverse[i]);
            //revert
            // swapNodes(cards[i], arr[cards.length-i-1]);
        }
        showAll();
        hideCards();
    }

    function setIndexesByTags(el, _tags) {
        let counter = 0;
        for (let i = 0; i < el.childNodes[5].childNodes.length; i++) {
            for (let c = 0; c < _tags.length; c++) {
                let one = el.childNodes[5].childNodes[i].innerText;
                if (one === _tags[c]) {
                    ++counter;
                }
            }
        }
        el.tagIndex = counter;
    }

    //swaps two nodes
    function swapNodes(node1, node2) {
        let node2_copy = node2.cloneNode(true);
        node1.parentNode.insertBefore(node2_copy, node1);
        node2.parentNode.insertBefore(node1, node2);
        node2.parentNode.replaceChild(node2, node2_copy);
    }

    //sort by number
    function sortNumber(a, b) {
        return a - b;
    }

    //get unique elements from arr
    function onlyUnique(value, index, self) {
        return self.indexOf(value) === index;
    }

    function setDateIndexes() {
        let dates = document.querySelectorAll('[class^="date"]');
        let cards = document.getElementsByClassName('card-box');
        let dateIndexes = [];
        //cards[i].timeIndex
        for (let i = 0; i < dates.length; i++) {
            cards[i].dateIndex = checkHours(dates[i].innerText);
            dateIndexes.push(checkHours(dates[i].innerText));
        }


        let sortedDates = dateIndexes.sort(sortNumber);
        for (let i = 0; i < cards.length; i++) {
            for (let c = 0; c < sortedDates.length; c++) {
                if (cards[i].dateIndex === sortedDates[c]) {
                    cards[i].dateIndex = c;
                }
            }
        }
    }

    function checkHours(_date) {
        let start = moment(_date, "YYYY-MM-DDTHH:mm:ss.SSSSZ");
        let end = moment();
        let diff = moment.duration(end.diff(start)).asDays();
        // console.log(`Difference is: ${diff}`);
        return Math.floor(diff);
    }

    function sortByDateUp() {
        selected_tags_arr = [];
        toggleDefaultTags();
        toggleButton(document.getElementById('sort-by-date').children[0]);
        // console.log('in sortByDateUp');
        localStorage.setItem('lastAction', JSON.stringify({
            'dateUp': true,
            'dateDown': false,
            'tags': false,
            'selected_tags': false
        }));
        let cards = document.getElementsByClassName('card-box');
        let arr = [];
        for (let i = 0; i < cards.length; i++) {
            for (let c = 0; c < cards.length; c++) {
                if (cards[i].dateIndex === c) {
                    // console.log(c);
                    arr[c] = cards[i];
                }
            }
        }
        for (let i = 0; i < cards.length; i++) {
            swapNodes(cards[i], arr[i]);
            //revert
            // swapNodes(cards[i], arr[cards.length-i-1]);
        }
        showAll();
        hideCards();
    }

    function sortByDateDown() {
        selected_tags_arr = [];
        toggleDefaultTags();
        toggleButton(document.getElementById('sort-by-date').children[1]);
        // console.log('in sortByDateDown');
        localStorage.setItem('lastAction', JSON.stringify({
            'dateUp': false,
            'dateDown': true,
            'tags': false,
            'selected_tags': false
        }));
        let cards = document.getElementsByClassName('card-box');
        let arr = [];
        for (let i = 0; i < cards.length; i++) {
            for (let c = 0; c < cards.length; c++) {
                if (cards[i].dateIndex === c) {
                    // console.log(c);
                    arr[c] = cards[i];
                }
            }
        }
        for (let i = 0; i < cards.length; i++) {
            swapNodes(cards[i], arr[cards.length - i - 1]);
        }
        showAll();
        hideCards();
    }

    let scrollCounter = 10;
    window.onscroll = function (event) {
        if ((window.innerHeight + window.pageYOffset) >= document.body.offsetHeight) {
            console.log(window.pageYOffset);
            if (scrollCounter <= 40) {
                scrollCounter = scrollCounter + 10;
                showNewCards(scrollCounter);
            }
        }
        // if (window.pageYOffset < 0) {
        //     hideCards();
        // }
    };

    function showNewCards(counter) {
        let count = counter;
        let cards = document.getElementsByClassName('card-box');
        for (let i = 0; i < cards.length; i++) {
            count--;
            if (i >= 10 && count >= 0) {
                cards[i].classList.remove('hide');
            }
        }
    }

    function hideCards() {
        scrollCounter = 10;
        let cards = document.getElementsByClassName('card-box');
        for (let i = 0; i < cards.length; i++) {
            if (i >= 10) {
                cards[i].classList.add('hide');
            }
        }
    }

    function showAll() {
        let cards = document.getElementsByClassName('card-box');
        for (let i = 0; i < cards.length; i++) {
            cards[i].classList.remove('hide');

        }
    }

</script>
</body>
</html>